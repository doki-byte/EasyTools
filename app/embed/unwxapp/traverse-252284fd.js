/*!
 * unveilr v2.0.1
 * (c) 2023 r3x5ur
 * Released under the GPL-3.0 License.
 */

"use strict";var parser=require("./parser-928e23b1.js"),worker_threads$1=require("worker_threads"),require$$0=require("observable-fns"),chalk=require("chalk"),winston=require("winston"),require$$7=require("fs"),promises=require("fs/promises"),require$$9=require("path"),CryptoJS=require("crypto-js"),prettier=require("prettier"),cssTree=require("css-tree"),babel=require("@babel/core");function _interopNamespaceDefault(e){var r=Object.create(null);return e&&Object.keys(e).forEach((function(t){if("default"!==t){var s=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,s.get?s:{enumerable:!0,get:function(){return e[t]}})}})),r.default=e,Object.freeze(r)}var CryptoJS__namespace=_interopNamespaceDefault(CryptoJS),babel__namespace=_interopNamespaceDefault(babel),WxapkgKeyFile,WxapkgType;exports.WxapkgKeyFile=void 0,WxapkgKeyFile=exports.WxapkgKeyFile||(exports.WxapkgKeyFile={}),WxapkgKeyFile.APP_CONFIG="app-config.json",WxapkgKeyFile.APP_SERVICE="app-service.js",WxapkgKeyFile.PAGE_FRAME_HTML="page-frame.html",WxapkgKeyFile.APP_WXSS="app-wxss.js",WxapkgKeyFile.COMMON_APP="common.app.js",WxapkgKeyFile.APP_JSON="app.json",WxapkgKeyFile.WORKERS="workers.js",WxapkgKeyFile.PAGE_FRAME="page-frame.js",WxapkgKeyFile.APPSERVICE="appservice.js",WxapkgKeyFile.PAGEFRAME="pageframe.js",WxapkgKeyFile.GAME="game.js",WxapkgKeyFile.GAME_JSON="game.json",WxapkgKeyFile.SUBCONTEXT="subContext.js",WxapkgKeyFile.PLUGIN="plugin.js",WxapkgKeyFile.PLUGIN_JSON="plugin.json",exports.WxapkgType=void 0,WxapkgType=exports.WxapkgType||(exports.WxapkgType={}),WxapkgType.APP_V1="APP_V1",WxapkgType.APP_V2="APP_V2",WxapkgType.APP_V3="APP_V3",WxapkgType.APP_V4="APP_V4",WxapkgType.APP_SUBPACKAGE_V1="APP_SUBPACKAGE_V1",WxapkgType.APP_SUBPACKAGE_V2="APP_SUBPACKAGE_V2",WxapkgType.APP_PLUGIN_V1="APP_PLUGIN_V1",WxapkgType.GAME="GAME",WxapkgType.GAME_SUBPACKAGE="GAME_SUBPACKAGE",WxapkgType.GAME_PLUGIN="GAME_PLUGIN",WxapkgType.FRAMEWORK="FRAMEWORK",exports.PackageSuffix=void 0,(exports.PackageSuffix||(exports.PackageSuffix={})).WXAPKG="wxapkg";const info=chalk.blue.bold,error=chalk.white.bgRed,grey=chalk.grey.bold,link=chalk.underline,bold=chalk.bold,red=chalk.red,yellow=chalk.yellow,green=chalk.green;class ConfigController{constructor(e){this.config=e}get innerConfig(){return Object.freeze(this.config)}get logLevel(){return this.config.global.logLevel}get WXReformat(){return this.config.wx.format}get WXClearDecompile(){return this.WXParse&&this.config.wx.clearDecompile}get WXClearSave(){return this.config.wx.clearSave}get WXDepth(){return this.config.wx.depth}get WXParse(){return this.config.wx.parse}get WXPackages(){return this.config.wx.packages}get WXAppId(){return this.config.wx.appid}get WXOutput(){return this.config.wx.output}get WxClearOutput(){return this.config.wx.clearOutput}static init(e){ConfigController.instance||(ConfigController.instance=new ConfigController(e))}static getInstance(){if(!ConfigController.instance)throw ReferenceError("ConfigController is not initialized");return ConfigController.instance}}function getConfig(e){const r=ConfigController.getInstance();if(!e)throw ReferenceError("Config name is required");return r[e]}function initializeConfig(e){ConfigController.init(e)}function getInnerConfig(){return ConfigController.getInstance().innerConfig}const{combine:combine,timestamp:timestamp,printf:printf,colorize:colorize}=winston.format,levels={error:0,warn:1,info:2,debug:3};function getLogger(e,r){return winston.createLogger({level:r||getConfig("logLevel"),levels:levels,format:combine(timestamp({format:"HH:mm:ss"}),printf((e=>{var r;return[`[${bold(e.level.toUpperCase())}]`,grey(e.timestamp),yellow(`<${e.scope}>`),(r=e)instanceof Error?r.stack:r.message].join(" ")})),colorize({all:!0})),defaultMeta:{scope:e||"Core"},transports:[new winston.transports.Console({stderrLevels:["error"]})]})}class BaseLogger{constructor(e,r){e=e||this.constructor.name,this.logger=getLogger(e.length<4?void 0:e,r)}}class GlobalExceptionCaught extends BaseLogger{constructor(){super("Exception");const e="exit,cancel,pass".split(","),r=r=>{!e.includes(String(r))&&this.logger.error(r),process.exit(1)};process.on("uncaughtException",r),process.on("unhandledRejection",r),this.logger.debug("Global exception interception is enabled")}}function registerGlobalException(){return new GlobalExceptionCaught}class BaseError extends Error{constructor(e){super(e),this.name=this.constructor.name,Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}static make(e){return new this(e)}static throw(e){throw this.make(e)}}class PathController{constructor(e){this.exists=!1,this.isDirectory=!1,this.isFile=!1,this.path=e||"",this.reload()}reload(){if(this.exists=require$$7.existsSync(this.path),this.exists)try{const e=require$$7.statSync(this.path);this.isDirectory=e.isDirectory(),this.isFile=e.isFile()}catch(e){-4058===e.errno&&(this.exists=!1),this.isDirectory=!1,this.isFile=!1}return this}get suffix(){return require$$9.extname(this.path)}get suffixWithout(){return this.suffix.slice(1)}get abspath(){return require$$9.resolve(this.path)}get unixpath(){return"/"===require$$9.sep?this.path:this.path.replace(/\\/g,"/")}get absunixpath(){return PathController.make(this.abspath).unixpath}get logpath(){const e=this.abspath.length-this.basename.length<=80?this.abspath:this.abspath.slice(0,80)+"..."+this.basename;return grey(e)}get dirname(){return this.isDirectory?this.path:(this.isFile,require$$9.dirname(this.path))}get basename(){return require$$9.basename(this.path)}get basenameWithout(){return require$$9.basename(this.path,this.suffix)}get isAbs(){return require$$9.isAbsolute(this.path)}relative(e){return PathController.make(require$$9.relative(this.path,PathController.make(e).path))}async readdir(e,r){if(!this.isDirectory)return null;const t=await promises.readdir(this.path,e);return r?t.map((e=>require$$9.resolve(this.abspath,e))):t}async read(e){return this.isFile?await promises.readFile(this.path,e):null}readSync(e){return require$$7.readFileSync(this.path,e)}async write(e,r){return await promises.writeFile(this.abspath,e,r),this}writeSync(e,r){return require$$7.writeFileSync(this.abspath,e,r),this}async writeJSON(e){return this.write(JSON.stringify(e,null,2),"utf8")}writeJSONSync(e){return this.writeSync(JSON.stringify(e,null,2),"utf8")}copy(e){const r=PathController.make(e);return this.isFile?(require$$7.copyFileSync(this.path,r.mkdir().abspath),this):this.isDirectory?(r.mkdir(!0),this.deepListDir().forEach((e=>{const t=PathController.make(require$$9.join(r.abspath,e.replace(this.abspath,"")));require$$7.copyFileSync(e,t.mkdir().abspath)})),this):this}move(e){return this.copy(e).abspath,this.isFile?require$$7.unlinkSync(this.abspath):this.isDirectory&&require$$7.rmdirSync(this.abspath,{recursive:!0}),PathController.make(e)}mkdir(e){if(this.exists)return this;const r=e?this.path:require$$9.dirname(this.path);return require$$7.mkdirSync(r,{recursive:!0}),this.reload(),this}async unlink(){await promises.unlink(this.abspath)}unlinkSync(){require$$7.unlinkSync(this.abspath),this.reload()}deepListDir(e,r){if(!this.isDirectory)return[];const t=[];let s,o;const i=s?this.absunixpath:this.unixpath;switch(arguments.length){case 0:s=!1,o=Number.MAX_SAFE_INTEGER;break;case 1:if("boolean"==typeof e)s=e,o=Number.MAX_SAFE_INTEGER;else{if("number"!=typeof e)throw new Error("arg1 must be boolean or number");s=!1,o=e||Number.MAX_SAFE_INTEGER}break;case 2:s=e,o=r||Number.MAX_SAFE_INTEGER}const n=e=>{require$$7.readdirSync(e).forEach((r=>{const s=require$$9.join(e,r);if(require$$7.statSync(s).isDirectory()){if(o!==Number.MAX_SAFE_INTEGER){if(1===o)return;let r;if(e===i)r=1;else{r=PathController.make(e).crop(i).unixpath.split("/").length+1}if(r>=o)return}n(s)}else t.push(s)}))};return n(i),t}join(...e){return PathController.make(require$$9.join(this.path,...e))}whitout(e){return this.join("..",this.basenameWithout+(e||""))}unix(){return PathController.make(this.unixpath)}crop(e){const r=this.unixpath.replace(PathController.make(e).unixpath+"/","");return PathController.make(r)}async rmrf(){await promises.rm(this.abspath,{recursive:!0,force:!0})}rmrfSync(){require$$7.rmSync(this.abspath,{recursive:!0,force:!0})}toString(){return this.logpath}static unix(e){return PathController.make(e).unix()}static whitout(e,r){return PathController.make(e).whitout(r)}static make(e){return(e=e||"")instanceof PathController?e:new PathController(e)}static dir(e){return PathController.make(PathController.make(e).dirname)}}function isProduciblePath(e){return"string"==typeof e||e instanceof PathController}const REFORMAT_MAP={wxss:"css",json:"json",wxs:"babel",js:"babel",wxml:"html"};function reformat(e,r){try{const t=checkSupport(e);return t?prettier.format(r,{parser:REFORMAT_MAP[t]}):r}catch(e){if(e instanceof SyntaxError)return r;throw e}}function checkSupport(e){const r=PathController.make(e).suffixWithout;return!!Object.keys(REFORMAT_MAP).includes(r)&&r}class SaveController extends BaseLogger{static getInstance(){return SaveController.instance||(SaveController.instance=new SaveController),SaveController.instance}static setIsClean(e){SaveController.isClean=e}static setIsSafeMode(e){SaveController.isSafeMode=e,e&&getSaveController().logger.warn("Safe mode is enabled, Will not write files to disk")}static setIsReFormat(e){SaveController.isReFormat=e,e&&getSaveController().logger.warn("Turning on code formatting can slow down some operations")}constructor(){super("Bucket"),this.fileBucket=new Map}get keys(){return Array.from(this.fileBucket.keys())}saveAbleMax(...e){const r=new Map;return e.forEach((e=>{return r.set((t=e,Buffer.isBuffer(t)||"string"==typeof t?t.length:JSON.stringify(t).length),e);var t})),r.get(Math.max(...r.keys()))}set(e,r){e&&(PathController.make(e).isAbs?(this.fileBucket.has(e)&&(SaveController.OVERRIDE_FILES.includes(PathController.make(e).basename)||(r=this.saveAbleMax(this.fileBucket.get(e),r))),this.fileBucket.set(e,r)):this.logger.warn(`Path ${e} is not absolute!`))}get(e){if(!e)return null;const r=PathController.make(e);return this.fileBucket.get(r.isAbs?r.path:r.abspath)||null}delete(e,r){if(!r&&!SaveController.isClean)return!1;if(!e)return!1;const t=PathController.make(e);return!!t.isAbs&&this.fileBucket.delete(t.path)}pop(e,r){const t=this.get(e);return this.delete(e,r),t||null}async saveFile(e,r){const t=PathController.make(e);let s;r||(this.logger.debug(`You are trying to save a falsy data to ${t.logpath}`),r=""),t.mkdir();const o=async e=>{switch(e){case"write":await t.write(r);break;case"writeUtf8":await t.write(String(r),"utf8");break;case"writeJSON":await t.writeJSON(r)}};let i;return"string"==typeof r?(i=o("writeUtf8"),s=`source-${t.suffixWithout}`):Buffer.isBuffer(r)?(i=o("write"),s="binary"):"object"==typeof r?(i=o("writeJSON"),s="json"):(this.logger.warn(`Path ${t.path} not allow write type: ${typeof r}`),i=o("writeUtf8")),s&&this.logger.debug(`File ${s} save to ${t.logpath}`),i}async flashDisk(){if(SaveController.isSafeMode)return;this.logger.debug("Flashing disk...");const e=this.keys.map((e=>{try{let r=this.pop(e,!0);return SaveController.isReFormat&&checkSupport(e)&&(r=reformat(e,saveAble2String(r))),this.saveFile(e,r)}catch(r){this.logger.error(`Error when saving file ${e}: ${r}`)}return null})).filter(Boolean);await Promise.all(e);const r=e.length.toString();r&&this.logger.info(`Storage has written ${info(r)} files`)}find(e){const r=this.fileBucket.keys(),t=[];if(!e)return[];for(const s of r){if(!s.startsWith(e))continue;const r=this.get(s);r&&t.push({key:s,buffer:r})}return t.filter(Boolean)}}async function flashDisk(){await getSaveController().flashDisk()}function findBuffer(e){const r=PathController.make(e).abspath;return getSaveController().find(r)}function saveAble2String(e){return e?Buffer.isBuffer(e)?e.toString():"string"==typeof e?e:JSON.stringify(e):""}function getSaveController(){return SaveController.getInstance()}function isWorkerRuntime$3(){return!worker_threads$1.isMainThread}function BufferToWordArray(e){return CryptoJS__namespace.lib.WordArray.create(e,e.length)}function WordArrayToBuffer(e){return Buffer.from(e.toString(CryptoJS__namespace.enc.Hex),"hex")}function decryptBuffer(e,r,t,s){if(e.length%32!=0)throw Error("Invalid buffer Length: "+e.length);const o=CryptoJS__namespace.PBKDF2(r,t,{keySize:8,iterations:1e3,hasher:CryptoJS__namespace.algo.SHA1});return WordArrayToBuffer(CryptoJS__namespace.AES.decrypt(BufferToWordArray(e).toString(CryptoJS__namespace.enc.Base64),o,{iv:CryptoJS__namespace.enc.Utf8.parse(s),mode:CryptoJS__namespace.mode.CBC,padding:CryptoJS__namespace.pad.NoPadding}))}function md5(e,r){let t;return t="string"==typeof e&&r?CryptoJS__namespace.enc.Base64.parse(e):e instanceof Buffer?BufferToWordArray(e):e,CryptoJS__namespace.MD5(t).toString(CryptoJS__namespace.enc.Hex)}SaveController.isClean=!1,SaveController.isSafeMode=!1,SaveController.isReFormat=!1,SaveController.OVERRIDE_FILES=[exports.WxapkgKeyFile.GAME,exports.WxapkgKeyFile.PLUGIN];class ParserError extends BaseError{}class BaseParser extends BaseLogger{constructor(e){super(),this.saver=e}}function matchScripts(e){const r=/<script\b[^>]*>(?<source>[\s\S]*?)<\/script>/m,t=[],s=e=>{const o=e.match(r);o&&o.groups&&(t.push(o.groups.source.trim()),s(e.replace(r,"")))};return s(e),t.filter(Boolean).join(";\n")}function transformStyle(e,r){const t=cssTree.parse(e);return cssTree.walk(t,(function(e){switch(e.type){case"Comment":{const r=e;r.type="Raw",r.value="\n/*"+e.value+"*/\n"}break;case"TypeSelector":{const r=e.name,t=e;r.startsWith("wx")?t.name=r.slice(3):"body"===r&&(t.name="page")}}if("children"in e&&e.children){const r=["webkit","moz","ms","o"],t={},s=e.children;s.forEach(((e,o)=>{if("Declaration"===e.type)if(t[e.property]){const i=t[e.property],n=i.data;let a;const l=e.value,c=n.value;if("Raw"==l.type&&l.value.startsWith("progid:DXImageTransform"))s.remove(o),a=i;else if("Raw"==c.type&&c.value.startsWith("progid:DXImageTransform"))s.remove(i),a=o;else{const e=l,t=n;let c=e.children&&e.children.first&&"name"in e.children.first&&e.children.first.name,u=t.children&&t.children.first&&"name"in t.children.first&&t.children.first.name;if(c&&u)for(const e of r){if(c===`-${e}-${u}`){s.remove(o),a=i;break}if(u===`-${e}-${c}`){s.remove(i),a=o;break}{const r=`-${e}-`;c.startsWith(r)&&(c=c.slice(r.length)),u.startsWith(r)&&(u=u.slice(r.length))}}}t[e.property]=a||i}else t[e.property]=o}));for(const e in t)if(!e.startsWith("-"))for(const o of r){const r=`-${o}-${e}`;t[r]&&(s.remove(t[r]),delete t[r])}}})),{buffer:cssTree.generate(t),path:r}}async function buildAST(e,r){let t=e;if(!r){const s=PathController.make(e);r=s.abspath,t=await s.read("utf8")}const s=await babel__namespace.parseAsync(t,{sourceFileName:r,sourceType:"script"});return new babel__namespace.File({filename:r},{ast:s,code:t})}async function traverseAST(e,r){if(isProduciblePath(e)){const t=await buildAST(e);return babel.traverse(t.ast,r)}if("object"==typeof e&&e.code&&(e.filename=e.filename||".")){const t=await buildAST(e.code,e.filename);return babel.traverse(t.ast,r)}return babel.traverse(e.ast,r)}function parseJSONFromJSCode(e,r){const t=new babel__namespace.File({filename:"."},{ast:babel__namespace.parseSync(e,{sourceType:"script"}),code:e});babel.traverse(t.ast,{CallExpression(e){throw Error(`This code snippet is not safe: ${error(e.getSource())}`)},AssignmentExpression(e){throw Error(`This code snippet is not safe: ${error(e.getSource())}`)}});const s=Function("context",`with(context){return JSON.stringify(${e})}`);try{return JSON.parse(s({JSON:JSON,...r}))}catch(e){console.log(s.toString())}}function makeCStyleName(e){return`./@unveilr/wxss/unveilr.${md5(e.toString()).slice(-6)}.wxss`}function styleConversion(e,r){const t=getLogger("StyleConversion"),s=parseJSONFromJSCode(r);if(!Array.isArray(s))return;const o=r=>{if(!Array.isArray(r))return r;if(1===r.length&&1===r[0])return"";switch(r[0]){case 0:return r[1]+"rpx";case 2:{const s=r[1];let i;if("number"==typeof s)i=makeCStyleName(s);else{if("string"!=typeof s)return Array.isArray(s)?o(s):(t.warn(`Unprocessed element found: ${JSON.stringify(s)}`),"");i=s}if(!i)return"";return PathController.make(e).relative(i).unixpath?`@import "${i.replace("./","/")}";\n`:""}default:return t.warn(`Unprocessed data found: ${JSON.stringify(r)}`),""}};return transformStyle(s.map((e=>o(e))).join("")).buffer}class WxssParser extends BaseParser{constructor(e){super(e)}static getHTMLStyleSource(e){const r=[],t=PathController.make(e),s=getSaveController(),o=[".appservice.js",".common.js",".webview.js"];return findBuffer(t).forEach((({key:e,buffer:t})=>{const i=PathController.make(e);if("html"!==i.suffixWithout.toLowerCase())return;if(i.basename===exports.WxapkgKeyFile.PAGE_FRAME_HTML)return;const n=saveAble2String(t);n&&r.push(matchScripts(n)),"html"===i.suffixWithout.toLowerCase()&&o.forEach((e=>s.delete(i.whitout(e).abspath))),s.delete(i.abspath)})),r.filter(Boolean).join(";\n")}async parse(e){const r=e=>{Object.entries(e).forEach((e=>this.saver.add(...e)))};let t;const s=new Promise((e=>t=e));return e.pipe(require$$0.filter((e=>e.WxssParserCommon))).subscribe({next:e=>r(e.WxssParserCommon),complete(){t&&t()}}),e.pipe(require$$0.filter((e=>e.WxssParserCommon2))).subscribe({next:e=>r(e.WxssParserCommon2),complete(){t&&t()}}),e.pipe(require$$0.filter((e=>e.WxssParser))).subscribe({next:e=>r(e.WxssParser),complete(){t&&t()}}),s}static visitorSetCssToHead(e){return{CallExpression(r){const t=r.node.callee;if("Identifier"===t.type&&"setCssToHead"===t.name){const t=r.get("arguments");if(!t.length||1===t.length&&"[]"===t[0].getSource())return;3===t.length&&t.splice(1,1);const[s,o]=t.map((e=>{const r=parseJSONFromJSCode(e.getSource());return r.path?r.path:r}));e.next({WxssParser:{[o]:styleConversion(o,JSON.stringify(s))}})}}}}static visitorCommonStyle(e){return{MemberExpression(r){const t=r.node;if("Identifier"===t.object.type&&"StringLiteral"===t.property.type&&"__COMMON_STYLESHEETS__"===t.object.name){const s=t.property.value;e.next({WxssParserCommon:{[s]:styleConversion(s,r.getOpposite().getSource())}})}}}}static visitorCArray(e){return{VariableDeclarator(r){const t=r.get("id"),s=r.get("init");t&&s&&t.isIdentifier()&&"_C"===t.getSource()&&s.isArrayExpression()&&s.get("elements").forEach(((r,t)=>{const s=makeCStyleName(t);e.next({WxssParserCommon2:{[s]:styleConversion(s,r.getSource())}})}))}}}}function hasOwnProperty(e,r){return Object.prototype.hasOwnProperty.call(e,r)}function deepCopy(e){if(null===e||"object"!=typeof e)return e;if(e instanceof Date){const r=new Date;return r.setTime(e.getTime()),r}if(e instanceof Array){const r=[];for(let t=0,s=e.length;t<s;t++)r[t]=deepCopy(e[t]);return r}if(e instanceof Object){const r={},t=e;for(const e in t)hasOwnProperty(t,e)&&(r[e]=deepCopy(t[e]));return r}throw new Error("Unable to copy obj! Its type isn't supported.")}const zArrayFunctionNameRE=/gz\$gwx\d*_[A-Za-z_0-9]+/,scopeNameRE=/\$gwx\d*$|\$gwx\d*_[A-Za-z_0-9]+/;function getFirst(e){return(Array.isArray(e)?e:[e])[0]}function getZArrayKey(e){const r=e.match(/_\d+$/);return r?r[0]:""}function makeVisitor(e){const r={mul:Object.create(null)},t={FunctionExpression(e){const t=e.getFunctionParent();if(!t)return;if(!t.isFunctionDeclaration())return;const s=t.get("id");if(!s)return;const o=s.getSource();if(!zArrayFunctionNameRE.test(o))return;const i=e.get("body.body"),n=Array.isArray(i)?i:[i],a=getZArrayKey(o);a&&(r.mul[a]=deepCopy(parser.wxmlParserJs.parseZArrayFromCode(n.map((e=>e.getSource())).join("\n"))))},VariableDeclarator(r){const t=r.get("id"),s=r.get("init");"nnm"===t.getSource()&&s.isObjectExpression()&&(e.json=s.getSource())}};return e.z=r,t}class WxmlParser extends BaseParser{constructor(e){super(e)}async parse(e){let r;const t=new Promise((e=>r=e));return e.pipe(require$$0.filter((e=>e.WxmlParserV3))).subscribe({next:e=>{const r=e.WxmlParserV3;if(!r)return;const{code:t,json:s,z:o}=r,i=this.dir;parser.wxmlParserJs.parseWxml(t,i,s,o).then((e=>{Object.entries(e).forEach((e=>this.saver.add(...e)))}))},complete(){r&&r()}}),t}async parseV1(){const e=await parser.wxmlParserJs.parseWxml(this.sources,this.dir);Object.entries(e).forEach((e=>this.saver.add(...e)))}get dir(){return this.saver.saveDirectory.path}static visitorV3(e){return{BlockStatement(r){const t=r.parentPath;if(!t)return;if(!t.isFunctionExpression())return;const s=t.get("params");if(2!==s.length)return;if("path"!==s[0].getSource()||"global"!==s[1].getSource())return;const o=r.find((e=>e.isAssignmentExpression()));if(!o)return;const i=getFirst(o.get("left")).getSource();if(!scopeNameRE.test(i))return;const n=Object.create(null);r.traverse(makeVisitor(n));const a=r.get("body").filter((e=>!e.isIfStatement()));let l=0;const c=a.findIndex((e=>{if(e.isVariableDeclaration()){const r=getFirst(e.get("declarations.0.id"));if(r&&r.isIdentifier()){const e=r.getSource();return"nv_require"===e?(l=1,!0):"x"===e}}return!1})),u=a.slice(c+l).map((e=>e.getSource())).join("\n");n.scope=i,n.code=u,e.next({WxmlParserV3:n})}}}setSource(e){this.sources=e}}class ScriptParser extends BaseParser{constructor(e){super(e)}async parse(e){let r;const t=new Promise((e=>r=e));return e.pipe(require$$0.filter((e=>e.ScriptParser))).subscribe({next:e=>{Object.entries(e.ScriptParser).forEach((([e,r])=>{e.startsWith("__plugin__")&&(PathController.make(e).suffixWithout||(e="__plugin__/index.js")),this.saver.add(e,r)}))},complete(){r&&r()}}),t}static visitor(e){return{CallExpression(r){const t=r.node.callee;if("Identifier"===t.type&&"define"===t.name){const t=r.get("arguments"),[s,o]=t;if(!s.isStringLiteral())return;if("FunctionExpression"!==o.node.type)return;const i=s.node.value,n=o.get("body.body"),a=(Array.isArray(n)?n:[n]).map((e=>e.getSource())).join("");e.next({ScriptParser:{[i]:a}})}}}}}class AppConfigParser extends BaseParser{constructor(e){super(e),this.isGame=!1}async parse(e){try{if(this.isGame)return this.parseGame();const r=this.saver.saveDirectory,t={...JSON.parse(this.sources),pop(e,r){const s=t[e];return delete t[e],s||r}},s=PathController.make(t.pop("entryPagePath")),o=t.pop("pages"),i=t.pop("global"),n=s.whitout().unixpath,a=new Set,l=(e,r)=>{const t=PathController.make(e).unixpath;a.has(t)||(a.add(t),this.saver.add(e,r))};o.splice(o.indexOf(n),1),o.unshift(n);const c=t.pop("subPackages");c&&(c.forEach((e=>{const r=e.root,t=e.pages||o.filter((e=>e.startsWith(r)));e.pages=t.map((e=>{const t=o.indexOf(e);return t>0&&o.splice(t,1),e.replace(r,"")}))})),this.logger.info(`AppConfigParser detected ${info(c.length.toString())} subpackages`));const u=t.pop("extAppid"),p=t.pop("ext");if(u&&p){const e=r.join("ext.json").writeJSONSync({extEnable:!0,extAppid:u,ext:p}).logpath;this.logger.info(`Ext save to ${e}`)}const f=t.pop("tabBar"),h="wxml,wxs,wxss,html,json";if(f&&Array.isArray(f.list)){const e=Object.create(null);findBuffer(r).forEach((({key:t,buffer:s})=>{const o=PathController.unix(t);h.includes(o.suffixWithout)||Buffer.isBuffer(s)&&(e[md5(s)]=o.crop(r.absunixpath).unixpath)})),f.list.forEach((r=>{if(r.pagePath=PathController.make(r.pagePath).whitout().unixpath,r.iconData){const t=e[md5(r.iconData,!0)];t&&(r.iconPath=PathController.make(t).unixpath,delete r.iconData)}if(r.selectedIconData){const t=e[md5(r.selectedIconData,!0)];t&&(r.selectedIconPath=PathController.make(t).unixpath,delete r.selectedIconData)}}))}const m=t.pop("page");t.pop("renderer"),Object.keys(m).forEach((e=>{const r=m[e].window.usingComponents;r&&Object.keys(r).length&&Object.keys(r).forEach((t=>{const s=r[t].replace(/plugin(-private)?:\/\//,"/__plugin__/"),o=s.startsWith("/")?s.slice(1):PathController.make(e).join("..",s).unixpath;m[o]=m[o]||Object.create(null),m[o].window=m[o].window||Object.create(null),m[o].window.component=!0}))}));const g=Object.assign(t,{tabBar:f,subPackages:c,...i,pages:o});let d;l(exports.WxapkgKeyFile.APP_JSON,g),this.serviceSource||ParserError.throw("Service source not found!");const b=new Promise((e=>d=e));return e.pipe(require$$0.filter((e=>e.AppConfigService))).subscribe({next:e=>{Object.entries(e.AppConfigService).forEach((e=>l(...e)))},complete(){Object.keys(m).forEach((e=>{let r=PathController.make(e);".json"!==r.suffix&&(r=r.whitout(".json")),l(r,m[e].window)})),d&&d()}}),b}catch(e){ParserError.throw("Parse failed! "+e.message)}}parseGame(){const e=JSON.parse(this.sources).subPackages;e&&this.logger.info(`AppConfigParser detected ${info(e.length.toString())} subpackages`),this.saver.add(exports.WxapkgKeyFile.GAME_JSON,this.sources)}setServiceSource(e){this.serviceSource=e}setSources(e){this.sources=e}setIsGame(e){this.isGame=e}static visitor(e){return{AssignmentExpression(r){const t=r.node.left;if(t&&"MemberExpression"===t.type&&"Identifier"===t.object.type&&"__wxAppCode__"===t.object.name&&"StringLiteral"===t.property.type&&t.property.value.endsWith(".json")){const s=t.property.value;r.traverse({ObjectExpression(r){"right"===r.parentKey&&e.next({AppConfigService:{[s]:r.getSource()}})}})}}}}}var worker={},isObservable=e=>!!e&&("symbol"==typeof Symbol.observable&&"function"==typeof e[Symbol.observable]?e===e[Symbol.observable]():"function"==typeof e["@@observable"]&&e===e["@@observable"]()),common={},serializers={};function extendSerializer(e,r){const t=e.deserialize.bind(e),s=e.serialize.bind(e);return{deserialize:e=>r.deserialize(e,t),serialize:e=>r.serialize(e,s)}}Object.defineProperty(serializers,"__esModule",{value:!0}),serializers.DefaultSerializer=serializers.extendSerializer=void 0,serializers.extendSerializer=extendSerializer;const DefaultErrorSerializer={deserialize:e=>Object.assign(Error(e.message),{name:e.name,stack:e.stack}),serialize:e=>({__error_marker:"$$error",message:e.message,name:e.name,stack:e.stack})},isSerializedError=e=>e&&"object"==typeof e&&"__error_marker"in e&&"$$error"===e.__error_marker;serializers.DefaultSerializer={deserialize:e=>isSerializedError(e)?DefaultErrorSerializer.deserialize(e):e,serialize:e=>e instanceof Error?DefaultErrorSerializer.serialize(e):e},Object.defineProperty(common,"__esModule",{value:!0}),common.serialize=common.deserialize=common.registerSerializer=void 0;const serializers_1=serializers;let registeredSerializer=serializers_1.DefaultSerializer;function registerSerializer(e){registeredSerializer=serializers_1.extendSerializer(registeredSerializer,e)}function deserialize(e){return registeredSerializer.deserialize(e)}function serialize(e){return registeredSerializer.serialize(e)}common.registerSerializer=registerSerializer,common.deserialize=deserialize,common.serialize=serialize;var transferable={},symbols={};Object.defineProperty(symbols,"__esModule",{value:!0}),symbols.$worker=symbols.$transferable=symbols.$terminate=symbols.$events=symbols.$errors=void 0,symbols.$errors=Symbol("thread.errors"),symbols.$events=Symbol("thread.events"),symbols.$terminate=Symbol("thread.terminate"),symbols.$transferable=Symbol("thread.transferable"),symbols.$worker=Symbol("thread.worker"),Object.defineProperty(transferable,"__esModule",{value:!0}),transferable.Transfer=transferable.isTransferDescriptor=void 0;const symbols_1=symbols;function isTransferable(e){return!(!e||"object"!=typeof e)}function isTransferDescriptor(e){return e&&"object"==typeof e&&e[symbols_1.$transferable]}function Transfer(e,r){if(!r){if(!isTransferable(e))throw Error();r=[e]}return{[symbols_1.$transferable]:!0,send:e,transferables:r}}transferable.isTransferDescriptor=isTransferDescriptor,transferable.Transfer=Transfer;var messages={};!function(e){var r,t;Object.defineProperty(e,"__esModule",{value:!0}),e.WorkerMessageType=e.MasterMessageType=void 0,(r=e.MasterMessageType||(e.MasterMessageType={})).cancel="cancel",r.run="run",(t=e.WorkerMessageType||(e.WorkerMessageType={})).error="error",t.init="init",t.result="result",t.running="running",t.uncaughtError="uncaughtError"}(messages);var implementation$1={},implementation_browser={};Object.defineProperty(implementation_browser,"__esModule",{value:!0});const isWorkerRuntime$2=function(){const e="undefined"!=typeof self&&"undefined"!=typeof Window&&self instanceof Window;return!("undefined"==typeof self||!self.postMessage||e)},postMessageToMaster$2=function(e,r){self.postMessage(e,r)},subscribeToMasterMessages$2=function(e){const r=r=>{e(r.data)};return self.addEventListener("message",r),()=>{self.removeEventListener("message",r)}};implementation_browser.default={isWorkerRuntime:isWorkerRuntime$2,postMessageToMaster:postMessageToMaster$2,subscribeToMasterMessages:subscribeToMasterMessages$2};var implementation_tinyWorker={};Object.defineProperty(implementation_tinyWorker,"__esModule",{value:!0}),"undefined"==typeof self&&(parser.commonjsGlobal.self=parser.commonjsGlobal);const isWorkerRuntime$1=function(){return!("undefined"==typeof self||!self.postMessage)},postMessageToMaster$1=function(e){self.postMessage(e)};let muxingHandlerSetUp=!1;const messageHandlers=new Set,subscribeToMasterMessages$1=function(e){muxingHandlerSetUp||(self.addEventListener("message",(e=>{messageHandlers.forEach((r=>r(e.data)))})),muxingHandlerSetUp=!0),messageHandlers.add(e);return()=>messageHandlers.delete(e)};implementation_tinyWorker.default={isWorkerRuntime:isWorkerRuntime$1,postMessageToMaster:postMessageToMaster$1,subscribeToMasterMessages:subscribeToMasterMessages$1};var implementation_worker_threads={},worker_threads={};let implementation;function selectImplementation(){return"function"==typeof __non_webpack_require__?__non_webpack_require__("worker_threads"):eval("require")("worker_threads")}function getImplementation(){return implementation||(implementation=selectImplementation()),implementation}Object.defineProperty(worker_threads,"__esModule",{value:!0}),worker_threads.default=getImplementation;var __importDefault$1=parser.commonjsGlobal&&parser.commonjsGlobal.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(implementation_worker_threads,"__esModule",{value:!0});const worker_threads_1=__importDefault$1(worker_threads);function assertMessagePort(e){if(!e)throw Error("Invariant violation: MessagePort to parent is not available.");return e}const isWorkerRuntime=function(){return!worker_threads_1.default().isMainThread},postMessageToMaster=function(e,r){assertMessagePort(worker_threads_1.default().parentPort).postMessage(e,r)},subscribeToMasterMessages=function(e){const r=worker_threads_1.default().parentPort;if(!r)throw Error("Invariant violation: MessagePort to parent is not available.");const t=r=>{e(r)};return assertMessagePort(r).on("message",t),()=>{assertMessagePort(r).off("message",t)}};function testImplementation(){worker_threads_1.default()}implementation_worker_threads.default={isWorkerRuntime:isWorkerRuntime,postMessageToMaster:postMessageToMaster,subscribeToMasterMessages:subscribeToMasterMessages,testImplementation:testImplementation};var __importDefault=parser.commonjsGlobal&&parser.commonjsGlobal.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(implementation$1,"__esModule",{value:!0});const implementation_browser_1=__importDefault(implementation_browser),implementation_tiny_worker_1=__importDefault(implementation_tinyWorker),implementation_worker_threads_1=__importDefault(implementation_worker_threads),runningInNode="undefined"!=typeof process&&"browser"!==process.arch&&"pid"in process;function selectNodeImplementation(){try{return implementation_worker_threads_1.default.testImplementation(),implementation_worker_threads_1.default}catch(e){return implementation_tiny_worker_1.default}}implementation$1.default=runningInNode?selectNodeImplementation():implementation_browser_1.default,function(e){var r=parser.commonjsGlobal&&parser.commonjsGlobal.__awaiter||function(e,r,t,s){return new(t||(t=Promise))((function(o,i){function n(e){try{l(s.next(e))}catch(e){i(e)}}function a(e){try{l(s.throw(e))}catch(e){i(e)}}function l(e){var r;e.done?o(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(n,a)}l((s=s.apply(e,r||[])).next())}))},t=parser.commonjsGlobal&&parser.commonjsGlobal.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(e,"__esModule",{value:!0}),e.expose=e.isWorkerRuntime=e.Transfer=e.registerSerializer=void 0;const s=t(isObservable),o=common,i=transferable,n=messages,a=t(implementation$1);var l=common;Object.defineProperty(e,"registerSerializer",{enumerable:!0,get:function(){return l.registerSerializer}});var c=transferable;Object.defineProperty(e,"Transfer",{enumerable:!0,get:function(){return c.Transfer}}),e.isWorkerRuntime=a.default.isWorkerRuntime;let u=!1;const p=new Map,f=e=>e&&e.type===n.MasterMessageType.cancel,h=e=>e&&e.type===n.MasterMessageType.run,m=e=>s.default(e)||function(e){return e&&"object"==typeof e&&"function"==typeof e.subscribe}(e);function g(e){return i.isTransferDescriptor(e)?{payload:e.send,transferables:e.transferables}:{payload:e,transferables:void 0}}function d(e,r){const{payload:t,transferables:s}=g(r),i={type:n.WorkerMessageType.error,uid:e,error:o.serialize(t)};a.default.postMessageToMaster(i,s)}function b(e,r,t){const{payload:s,transferables:o}=g(t),i={type:n.WorkerMessageType.result,uid:e,complete:!!r||void 0,payload:s};a.default.postMessageToMaster(i,o)}function y(e){try{const r={type:n.WorkerMessageType.uncaughtError,error:o.serialize(e)};a.default.postMessageToMaster(r)}catch(r){console.error("Not reporting uncaught error back to master thread as it occured while reporting an uncaught error already.\nLatest error:",r,"\nOriginal error:",e)}}function x(e,t,s){return r(this,void 0,void 0,(function*(){let r;try{r=t(...s)}catch(r){return d(e,r)}const i=m(r)?"observable":"promise";if(function(e,r){const t={type:n.WorkerMessageType.running,uid:e,resultType:r};a.default.postMessageToMaster(t)}(e,i),m(r)){const t=r.subscribe((r=>b(e,!1,o.serialize(r))),(r=>{d(e,o.serialize(r)),p.delete(e)}),(()=>{b(e,!0),p.delete(e)}));p.set(e,t)}else try{const t=yield r;b(e,!0,o.serialize(t))}catch(r){d(e,o.serialize(r))}}))}e.expose=function(e){if(!a.default.isWorkerRuntime())throw Error("expose() called in the master thread.");if(u)throw Error("expose() called more than once. This is not possible. Pass an object to expose() if you want to expose multiple functions.");if(u=!0,"function"==typeof e)a.default.subscribeToMasterMessages((r=>{h(r)&&!r.method&&x(r.uid,e,r.args.map(o.deserialize))})),function(){const e={type:n.WorkerMessageType.init,exposed:{type:"function"}};a.default.postMessageToMaster(e)}();else{if("object"!=typeof e||!e)throw Error(`Invalid argument passed to expose(). Expected a function or an object, got: ${e}`);a.default.subscribeToMasterMessages((r=>{h(r)&&r.method&&x(r.uid,e[r.method],r.args.map(o.deserialize))}));!function(e){const r={type:n.WorkerMessageType.init,exposed:{type:"module",methods:e}};a.default.postMessageToMaster(r)}(Object.keys(e).filter((r=>"function"==typeof e[r])))}a.default.subscribeToMasterMessages((e=>{if(f(e)){const r=e.uid,t=p.get(r);t&&(t.unsubscribe(),p.delete(r))}}))},"undefined"!=typeof self&&"function"==typeof self.addEventListener&&a.default.isWorkerRuntime()&&(self.addEventListener("error",(e=>{setTimeout((()=>y(e.error||e)),250)})),self.addEventListener("unhandledrejection",(e=>{const r=e.reason;r&&"string"==typeof r.message&&setTimeout((()=>y(r)),250)}))),"undefined"!=typeof process&&"function"==typeof process.on&&a.default.isWorkerRuntime()&&(process.on("uncaughtException",(e=>{setTimeout((()=>y(e)),250)})),process.on("unhandledRejection",(e=>{e&&"string"==typeof e.message&&setTimeout((()=>y(e)),250)})))}(worker);var WorkerContext=parser.getDefaultExportFromCjs(worker);const expose=WorkerContext.expose;var observable={};!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.Subject=e.Observable=void 0;const r=require$$0;Object.defineProperty(e,"Observable",{enumerable:!0,get:function(){return r.Observable}});const t=Symbol("observers");class s extends r.Observable{constructor(){super((e=>{this[t]=[...this[t]||[],e];return()=>{this[t]=this[t].filter((r=>r!==e))}})),this[t]=[]}complete(){this[t].forEach((e=>e.complete()))}error(e){this[t].forEach((r=>r.error(e)))}next(e){this[t].forEach((r=>r.next(e)))}}e.Subject=s}(observable);var Observables=parser.getDefaultExportFromCjs(observable);const Observable=Observables.Observable,Subject=Observables.Subject;class TraverseController{constructor(e,r){this.setFileBuilder(e),this.addVisitors(r)}addVisitors(...e){return this.visitors=this._mergeVisitors(...e),this}async traverse(e){return traverseAST(this.fileBuilder,{...this.visitors,...e})}_mergeVisitors(...e){const r={};return[this.visitors,...e].filter(Boolean).forEach((e=>{"object"==typeof e&&Object.keys(e).forEach((t=>{Array.isArray(r[t])?r[t].push(e[t]):r[t]=[e[t]]}))})),Object.keys(r).forEach((e=>{const t=[...r[e]];r[e]=(...e)=>t.forEach((r=>r.apply(this,e)))})),r}setFileBuilder(e){return this.fileBuilder=e,this}}function createExposed(){const e=new Subject,r={},t={AppConfigService:AppConfigParser.visitor,WxssParser:WxssParser.visitorSetCssToHead,WxssParserCommon:WxssParser.visitorCommonStyle,WxssParserCommon2:WxssParser.visitorCArray,ScriptParser:ScriptParser.visitor,WxmlParserV3:WxmlParser.visitorV3};return{initWorker(e){initializeConfig(e)},async startTraverse(t){const s=new TraverseController({code:t});s.addVisitors(...Object.values(r)),await s.traverse(),e.complete()},setVisitor(...s){s.forEach((s=>r[s]=t[s](e)))},observable:()=>Observable.from(e)}}isWorkerRuntime$3()&&expose(createExposed());const traverseModule=module;exports.AppConfigParser=AppConfigParser,exports.BaseError=BaseError,exports.BaseLogger=BaseLogger,exports.PathController=PathController,exports.SaveController=SaveController,exports.ScriptParser=ScriptParser,exports.WxmlParser=WxmlParser,exports.WxssParser=WxssParser,exports.createExposed=createExposed,exports.decryptBuffer=decryptBuffer,exports.flashDisk=flashDisk,exports.getConfig=getConfig,exports.getInnerConfig=getInnerConfig,exports.getSaveController=getSaveController,exports.green=green,exports.info=info,exports.initializeConfig=initializeConfig,exports.isProduciblePath=isProduciblePath,exports.isWorkerRuntime=isWorkerRuntime$3,exports.link=link,exports.matchScripts=matchScripts,exports.red=red,exports.registerGlobalException=registerGlobalException,exports.saveAble2String=saveAble2String,exports.traverseModule=traverseModule,exports.yellow=yellow;
